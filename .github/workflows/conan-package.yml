name: Conan package & publish

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      remote:
        required: true
        type: string
      is_rc:
        required: false
        type: boolean
        default: false

jobs:
  package:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            profile: linux
          - os: macos-latest
            profile: macos
          - os: windows-latest
            profile: windows
    runs-on: ${{ matrix.os }}
    outputs:
      conan_version: ${{ env.CONAN_VERSION }}

    steps:
      - uses: actions/checkout@v4

      - uses: conan-io/setup-conan@v1
        with:
          version: 2.24.0

      - name: Get short git SHA
        id: sha
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        shell: bash

      - name: Set RC version with git SHA
        if: ${{ inputs.is_rc }}
        run: echo "CONAN_VERSION=${{ inputs.version }}${{ steps.sha.outputs.short_sha }}" >> $GITHUB_ENV
        shell: bash

      - name: Set Release version
        if: ${{ !inputs.is_rc }}
        run: echo "CONAN_VERSION=${{ inputs.version }}" >> $GITHUB_ENV
        shell: bash

      - name: Configure Conan remotes
        run: |
          # Clean and re-add upload-capable remotes from secrets
          conan remote remove conan-rc --force || true
          conan remote remove conan-stable --force || true
          conan remote add conancenter https://center.conan.io --force || true
          conan remote add conan-rc "${{ secrets.CONAN_RC_URL }}" --force
          conan remote add conan-stable "${{ secrets.CONAN_STABLE_URL }}" --force
          conan remote list
        shell: bash

      - name: Detect profile
        run: conan profile detect --force
        shell: bash

      - name: Authenticate to Conan remote
        run: |
          conan remote login "${{ inputs.remote }}" "${{ secrets.CONAN_USERNAME }}" -p "${{ secrets.CONAN_PASSWORD }}"
        shell: bash
        continue-on-error: true

      - name: Block if base version exists in conan-stable (RC builds)
        if: ${{ inputs.is_rc }}
        run: |
          # Extract base version without -dev suffix
          BASE_VERSION=$(echo "${{ env.CONAN_VERSION }}" | sed 's/-dev-.*//')
          echo "Checking if base version mylib/${BASE_VERSION} exists in conan-stable..."
          
          if conan list "mylib/${BASE_VERSION}" --remote=conan-stable 2>&1 | grep -q "mylib/${BASE_VERSION}"; then
            echo "ERROR: Release version mylib/${BASE_VERSION} already exists in conan-stable!"
            echo "Cannot create RC for a version that's already been released."
            echo "Please bump VERSION to the next version (e.g., from ${BASE_VERSION} to next version)."
            exit 1
          fi
          
          echo "✓ Base version ${BASE_VERSION} not found in conan-stable, safe to proceed with RC"
        shell: bash
        env:
          CONAN_LOGIN_USERNAME: ${{ secrets.CONAN_USERNAME }}
          CONAN_PASSWORD: ${{ secrets.CONAN_PASSWORD }}

      - name: Check if release version exists in conan-stable (Release builds)
        if: ${{ !inputs.is_rc }}
        run: |
          echo "Checking if mylib/${{ env.CONAN_VERSION }} exists in conan-stable..."
          
          if conan list "mylib/${{ env.CONAN_VERSION }}" --remote=conan-stable 2>&1 | grep -q "mylib/${{ env.CONAN_VERSION }}"; then
            echo "ERROR: Release version mylib/${{ env.CONAN_VERSION }} already exists in conan-stable!"
            echo "Cannot release a version that's already been released."
            exit 1
          fi
          
          echo "✓ Version ${{ env.CONAN_VERSION }} not found in conan-stable, safe to proceed with release"
        shell: bash
        env:
          CONAN_LOGIN_USERNAME: ${{ secrets.CONAN_USERNAME }}
          CONAN_PASSWORD: ${{ secrets.CONAN_PASSWORD }}

      - name: Create Conan package
        run: conan create . --version=${{ env.CONAN_VERSION }} --build=missing
        env:
          CONAN_VERSION: ${{ env.CONAN_VERSION }}
          CONAN_LOGIN_USERNAME: ${{ secrets.CONAN_USERNAME }}
          CONAN_PASSWORD: ${{ secrets.CONAN_PASSWORD }}

      - name: Verify package was created
        run: conan list "mylib/${{ env.CONAN_VERSION }}"
        shell: bash

      - name: Test package locally (before upload)
        if: ${{ inputs.is_rc }}
        run: |
          echo "Testing RC package from local cache before uploading..."
          cd consumer-test
          conan install --requires=mylib/${{ env.CONAN_VERSION }} \
            -g CMakeDeps -g CMakeToolchain \
            --build=missing \
            -of build
          cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=build/conan_toolchain.cmake -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release
          ./build/Release/consumer_test || ./build/consumer_test
          echo "✓ Local integration test passed"
        shell: bash
        continue-on-error: false

      - name: Upload to remote
        run: |
          echo "Uploading mylib/${{ env.CONAN_VERSION }} to ${{ inputs.remote }}"
          conan upload "mylib/${{ env.CONAN_VERSION }}" --remote="${{ inputs.remote }}" --confirm
          echo "Upload completed successfully"
        shell: bash