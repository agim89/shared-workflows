# name: Create Release

# on:
#   workflow_call:
#     inputs:
#       version:
#         required: true
#         type: string

# jobs:
#   release:
#     runs-on: ubuntu-latest
#     permissions:
#       contents: write
#       packages: write
    
#     steps:
#       - uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       - uses: conan-io/setup-conan@v1
#         with:
#           version: 2.24.0

#       - name: Configure Conan remotes
#         run: |
#           conan remote add conan-rc "${{ secrets.CONAN_RC_URL }}" --force || true
#           conan remote add conan-stable "${{ secrets.CONAN_STABLE_URL }}" --force || true

#       - name: Download RC package from conan-rc
#         run: |
#           # Get short SHA from last RC build
#           git log --oneline -1
#           SHORT_SHA=$(git rev-parse --short HEAD)
#           RC_VERSION="${{ inputs.version }}-dev-${SHORT_SHA}"
#           echo "RC_VERSION=${RC_VERSION}" >> $GITHUB_ENV
#           echo "FINAL_VERSION=${{ inputs.version }}" >> $GITHUB_ENV

#       - name: Promote RC to stable
#         run: |
#           conan download "mylib/${{ env.RC_VERSION }}" --remote=conan-rc
#           conan upload "mylib/${{ env.FINAL_VERSION }}" --remote=conan-stable --confirm
#         env:
#           CONAN_LOGIN_USERNAME: ${{ secrets.CONAN_USERNAME }}
#           CONAN_PASSWORD: ${{ secrets.CONAN_PASSWORD }}
#         continue-on-error: false

#       - name: Create Git tag
#         run: |
#           git tag -a "v${{ env.FINAL_VERSION }}" -m "Release ${{ env.FINAL_VERSION }}"
#           git push origin "v${{ env.FINAL_VERSION }}"

#       - name: Create GitHub Release
#         uses: actions/create-release@v1
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#         with:
#           tag_name: v${{ env.FINAL_VERSION }}
#           release_name: Release ${{ env.FINAL_VERSION }}
#           body: |
#             Automated release of mylib ${{ env.FINAL_VERSION }}
            
#             **Package Reference:** `mylib/${{ env.FINAL_VERSION }}`
#             **Remote:** `conan-stable`
            
#             Install with:
#             ```
#             conan install --requires=mylib/${{ env.FINAL_VERSION }}
#             ```
#           draft: false
#           prerelease: false

name: Create Release

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      rc_version:
        required: false
        type: string
        default: ""
        description: "Exact RC version to promote (e.g., 1.2.0-dev-abc1234). If not provided, the most recent RC is used."

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: conan-io/setup-conan@v1
        with:
          version: 2.24.0

      - name: Configure Conan remotes
        run: |
          conan remote remove conan-rc --force || true
          conan remote remove conan-stable --force || true
          conan remote add conancenter https://center.conan.io --force || true
          conan remote add conan-rc "${{ secrets.CONAN_RC_URL }}" --force
          conan remote add conan-stable "${{ secrets.CONAN_STABLE_URL }}" --force
          conan remote list
        shell: bash

      - name: Authenticate to Conan remotes
        run: |
          # Authenticate to both remotes; promotion requires access to conan-stable
          conan remote login conan-rc "${{ secrets.CONAN_USERNAME }}" -p "${{ secrets.CONAN_PASSWORD }}" || true
          conan remote login conan-stable "${{ secrets.CONAN_USERNAME }}" -p "${{ secrets.CONAN_PASSWORD }}"
          conan remote list
        shell: bash

      - name: Download RC package from conan-rc
        run: |
          if [ -n "${{ inputs.rc_version }}" ]; then
            # Use explicit RC version from input
            RC_VERSION="${{ inputs.rc_version }}"
            echo "Using provided RC version: ${RC_VERSION}"
          else
            # Query for the most recent RC version
            echo "Querying for most recent RC version matching ${{ inputs.version }}-dev-*"
            RC_VERSION=$(conan list "mylib/${{ inputs.version }}-dev-*" --remote=conan-rc 2>/dev/null | grep "mylib/" | tail -1 | sed 's/.*mylib\///' | tr -d ' ')
            if [ -z "${RC_VERSION}" ]; then
              echo "ERROR: No RC version found matching ${{ inputs.version }}-dev-*"
              exit 1
            fi
            echo "Found RC version: ${RC_VERSION}"
          fi
          
          echo "RC_VERSION=${RC_VERSION}" >> $GITHUB_ENV
          echo "FINAL_VERSION=${{ inputs.version }}" >> $GITHUB_ENV
          echo "Attempting to download: mylib/${RC_VERSION}"

      - name: Verify RC package exists
        run: |
          echo "Verifying RC package exists: mylib/${{ env.RC_VERSION }}"
          conan download "mylib/${{ env.RC_VERSION }}" --remote=conan-rc
        env:
          CONAN_LOGIN_USERNAME: ${{ secrets.CONAN_USERNAME }}
          CONAN_PASSWORD: ${{ secrets.CONAN_PASSWORD }}
        shell: bash

      - name: Copy RC package to release version
        run: |
          echo "Copying mylib/${{ env.RC_VERSION }} to mylib/${{ env.FINAL_VERSION }}"
          conan copy "mylib/${{ env.RC_VERSION }}:*" --folder=. mylib/${{ env.FINAL_VERSION }}@
        shell: bash

      - name: Promote RC to stable
        run: |
          echo "Promoting mylib/${{ env.FINAL_VERSION }} to conan-stable"
          conan upload "mylib/${{ env.FINAL_VERSION }}" --remote=conan-stable --confirm
        env:
          CONAN_LOGIN_USERNAME: ${{ secrets.CONAN_USERNAME }}
          CONAN_PASSWORD: ${{ secrets.CONAN_PASSWORD }}
        shell: bash

      - name: Create Git tag
        run: |
          git tag -a "v${{ env.FINAL_VERSION }}" -m "Release ${{ env.FINAL_VERSION }}"
          git push origin "v${{ env.FINAL_VERSION }}"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.FINAL_VERSION }}
          release_name: Release ${{ env.FINAL_VERSION }}
          body: |
            Automated release of mylib ${{ env.FINAL_VERSION }}
            
            **Package Reference:** `mylib/${{ env.FINAL_VERSION }}`
            **Remote:** `conan-stable`
            
            Install with:
            ```
            conan install --requires=mylib/${{ env.FINAL_VERSION }}
            ```
          draft: false
          prerelease: false