# name: Create Release

# on:
#   workflow_call:
#     inputs:
#       version:
#         required: true
#         type: string

# jobs:
#   release:
#     runs-on: ubuntu-latest
#     permissions:
#       contents: write
#       packages: write
    
#     steps:
#       - uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       - uses: conan-io/setup-conan@v1
#         with:
#           version: 2.24.0

#       - name: Configure Conan remotes
#         run: |
#           conan remote add conan-rc "${{ secrets.CONAN_RC_URL }}" --force || true
#           conan remote add conan-stable "${{ secrets.CONAN_STABLE_URL }}" --force || true

#       - name: Download RC package from conan-rc
#         run: |
#           # Get short SHA from last RC build
#           git log --oneline -1
#           SHORT_SHA=$(git rev-parse --short HEAD)
#           RC_VERSION="${{ inputs.version }}-dev-${SHORT_SHA}"
#           echo "RC_VERSION=${RC_VERSION}" >> $GITHUB_ENV
#           echo "FINAL_VERSION=${{ inputs.version }}" >> $GITHUB_ENV

#       - name: Promote RC to stable
#         run: |
#           conan download "mylib/${{ env.RC_VERSION }}" --remote=conan-rc
#           conan upload "mylib/${{ env.FINAL_VERSION }}" --remote=conan-stable --confirm
#         env:
#           CONAN_LOGIN_USERNAME: ${{ secrets.CONAN_USERNAME }}
#           CONAN_PASSWORD: ${{ secrets.CONAN_PASSWORD }}
#         continue-on-error: false

#       - name: Create Git tag
#         run: |
#           git tag -a "v${{ env.FINAL_VERSION }}" -m "Release ${{ env.FINAL_VERSION }}"
#           git push origin "v${{ env.FINAL_VERSION }}"

#       - name: Create GitHub Release
#         uses: actions/create-release@v1
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#         with:
#           tag_name: v${{ env.FINAL_VERSION }}
#           release_name: Release ${{ env.FINAL_VERSION }}
#           body: |
#             Automated release of mylib ${{ env.FINAL_VERSION }}
            
#             **Package Reference:** `mylib/${{ env.FINAL_VERSION }}`
#             **Remote:** `conan-stable`
            
#             Install with:
#             ```
#             conan install --requires=mylib/${{ env.FINAL_VERSION }}
#             ```
#           draft: false
#           prerelease: false

name: Create Release

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
        description: "Release version (e.g., 1.3.0). The workflow will find and promote the matching RC."

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: conan-io/setup-conan@v1
        with:
          version: 2.24.0

      - name: Configure Conan remotes
        run: |
          conan remote remove conan-rc --force || true
          conan remote remove conan-stable --force || true
          conan remote add conancenter https://center.conan.io --force || true
          conan remote add conan-rc "${{ secrets.CONAN_RC_URL }}" --force
          conan remote add conan-stable "${{ secrets.CONAN_STABLE_URL }}" --force
          conan remote list
        shell: bash

      - name: Authenticate to Conan remotes
        run: |
          # Authenticate to both remotes; promotion requires access to conan-stable
          conan remote login conan-rc "${{ secrets.CONAN_USERNAME }}" -p "${{ secrets.CONAN_PASSWORD }}" || true
          conan remote login conan-stable "${{ secrets.CONAN_USERNAME }}" -p "${{ secrets.CONAN_PASSWORD }}"
          conan remote list
        shell: bash

      - name: Find and prepare RC for promotion
        run: |
          echo "Finding RC version matching ${{ inputs.version }}-dev-*"
          RC_VERSION=$(conan list "mylib/${{ inputs.version }}-dev-*" --remote=conan-rc 2>/dev/null | grep "mylib/" | tail -1 | sed 's/.*mylib\///' | tr -d ' ')
          
          if [ -z "${RC_VERSION}" ]; then
            echo "ERROR: No RC version found matching ${{ inputs.version }}-dev-*"
            exit 1
          fi
          
          echo "Found RC version: ${RC_VERSION}"
          echo "RC_VERSION=${RC_VERSION}" >> $GITHUB_ENV
          echo "FINAL_VERSION=${{ inputs.version }}" >> $GITHUB_ENV
          echo "Promoting ${RC_VERSION} to conan-stable"
        shell: bash

      - name: Download RC package from conan-rc
        run: |
          echo "Downloading mylib/${{ env.RC_VERSION }}:* from conan-rc"
          conan download "mylib/${{ env.RC_VERSION }}:*" --remote=conan-rc
        env:
          CONAN_LOGIN_USERNAME: ${{ secrets.CONAN_USERNAME }}
          CONAN_PASSWORD: ${{ secrets.CONAN_PASSWORD }}
        shell: bash

      - name: Promote RC to stable
        run: |
          echo "RC package in cache:"
          conan list "mylib/${{ env.RC_VERSION }}"
          echo ""
          echo "Uploading mylib/${{ env.RC_VERSION }} to conan-stable"
          conan upload "mylib/${{ env.RC_VERSION }}:*" --remote=conan-stable --confirm
        env:
          CONAN_LOGIN_USERNAME: ${{ secrets.CONAN_USERNAME }}
          CONAN_PASSWORD: ${{ secrets.CONAN_PASSWORD }}
        shell: bash

      - name: Configure git user
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
        shell: bash

      - name: Create Git tag
        run: |
          if git rev-parse "v${{ env.FINAL_VERSION }}" >/dev/null 2>&1; then
            echo "Tag v${{ env.FINAL_VERSION }} already exists, deleting and recreating..."
            git tag -d "v${{ env.FINAL_VERSION }}"
            git push origin ":refs/tags/v${{ env.FINAL_VERSION }}" || true
          fi
          git tag -a "v${{ env.FINAL_VERSION }}" -m "Release ${{ env.FINAL_VERSION }}"
          git push origin "v${{ env.FINAL_VERSION }}"
        shell: bash

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.FINAL_VERSION }}
          release_name: Release ${{ env.FINAL_VERSION }}
          body: |
            Automated release of mylib ${{ env.FINAL_VERSION }}
            
            **Package Reference:** `mylib/${{ env.FINAL_VERSION }}`
            **Remote:** `conan-stable`
            
            Install with:
            ```
            conan install --requires=mylib/${{ env.FINAL_VERSION }}
            ```
          draft: false
          prerelease: false