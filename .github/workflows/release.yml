name: Create Release

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
        description: "Release version (e.g., 1.3.0). The workflow will find and promote the matching RC."

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: conan-io/setup-conan@v1
        with:
          version: 2.24.0

      - name: Configure Conan remotes
        run: |
          conan remote remove conan-rc --force || true
          conan remote remove conan-stable --force || true
          conan remote add conancenter https://center.conan.io --force || true
          conan remote add conan-rc "${{ secrets.CONAN_RC_URL }}" --force
          conan remote add conan-stable "${{ secrets.CONAN_STABLE_URL }}" --force
          conan remote list
        shell: bash

      - name: Authenticate to Conan remotes
        run: |
          # Authenticate to both remotes; promotion requires access to conan-stable
          conan remote login conan-rc "${{ secrets.CONAN_USERNAME }}" -p "${{ secrets.CONAN_PASSWORD }}" || true
          conan remote login conan-stable "${{ secrets.CONAN_USERNAME }}" -p "${{ secrets.CONAN_PASSWORD }}"
          conan remote list
        shell: bash

      - name: Verify RC package exists
        run: |
          echo "Finding RC version matching ${{ inputs.version }}-dev-*"
          RC_VERSION=$(conan list "mylib/${{ inputs.version }}-dev-*" --remote=conan-rc 2>/dev/null | grep "mylib/" | tail -1 | sed 's/.*mylib\///' | tr -d ' ')
          
          if [ -z "${RC_VERSION}" ]; then
            echo "ERROR: No RC version found matching ${{ inputs.version }}-dev-*"
            exit 1
          fi
          
          echo "Found RC version: ${RC_VERSION}"
          echo "RC was tested and verified, now building clean release package"
          echo "FINAL_VERSION=${{ inputs.version }}" >> $GITHUB_ENV
        shell: bash

      - name: Build release package from source
        run: |
          echo "Building mylib/${{ env.FINAL_VERSION }} from source"
          conan create . --version=${{ env.FINAL_VERSION }} --build=missing
        env:
          CONAN_VERSION: ${{ env.FINAL_VERSION }}
          CONAN_LOGIN_USERNAME: ${{ secrets.CONAN_USERNAME }}
          CONAN_PASSWORD: ${{ secrets.CONAN_PASSWORD }}
        shell: bash

      - name: Upload release package to conan-stable
        run: |
          echo "Uploading mylib/${{ env.FINAL_VERSION }} to conan-stable"
          conan upload "mylib/${{ env.FINAL_VERSION }}:*" --remote=conan-stable --confirm
        env:
          CONAN_LOGIN_USERNAME: ${{ secrets.CONAN_USERNAME }}
          CONAN_PASSWORD: ${{ secrets.CONAN_PASSWORD }}
        shell: bash

      - name: Configure git user
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
        shell: bash

      - name: Create Git tag
        run: |
          TAG_NAME="v${{ env.FINAL_VERSION }}"
          
          # Check if tag already exists on remote
          if git ls-remote --tags origin "${TAG_NAME}" | grep -q "${TAG_NAME}"; then
            echo "ERROR: Tag ${TAG_NAME} already exists on remote. This version may already be released."
            echo "If re-releasing is needed, delete the tag manually: git push origin :refs/tags/${TAG_NAME}"
            exit 1
          fi
          
          # Create and push tag
          git tag -a "${TAG_NAME}" -m "Release ${{ env.FINAL_VERSION }}"
          git push origin "${TAG_NAME}"
        shell: bash

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.FINAL_VERSION }}
          release_name: Release ${{ env.FINAL_VERSION }}
          body: |
            Automated release of mylib ${{ env.FINAL_VERSION }}
            
            **Package Reference:** `mylib/${{ env.FINAL_VERSION }}`
            **Remote:** `conan-stable`
            
            Install with:
            ```
            conan install --requires=mylib/${{ env.FINAL_VERSION }}
            ```
          draft: false
          prerelease: false